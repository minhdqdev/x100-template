#!/usr/bin/env bash
set -euo pipefail

# Resolve the directory of this script, following symlinks
SOURCE=${BASH_SOURCE[0]:-$0}
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR=$(cd -P "$(dirname "$SOURCE")" >/dev/null 2>&1 && pwd)
  SOURCE=$(readlink "$SOURCE")
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR=$(cd -P "$(dirname "$SOURCE")" >/dev/null 2>&1 && pwd)

# Require uv (https://github.com/astral-sh/uv)
if ! command -v uv >/dev/null 2>&1; then
  echo "Error: 'uv' not found on PATH." >&2
  echo "Install uv: brew install uv  # macOS" >&2
  echo "Or: curl -LsSf https://astral.sh/uv/install.sh | sh" >&2
  exit 127
fi

VENV_DIR="${SCRIPT_DIR}/.venv"

# Create venv if missing using uv
if [ ! -d "$VENV_DIR" ]; then
  echo "Creating virtual environment with uv at $VENV_DIR"
  uv venv "$VENV_DIR"
fi

# Optional: install deps if requirements.txt exists
if [ -f "${SCRIPT_DIR}/requirements.txt" ]; then
  echo "Installing dependencies with uv pip"
  uv pip install -p "$VENV_DIR" -r "${SCRIPT_DIR}/requirements.txt"
fi

PY="$VENV_DIR/bin/python"
exec "$PY" "$SCRIPT_DIR/main.py" "$@"
